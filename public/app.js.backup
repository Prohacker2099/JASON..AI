// WebSocket connection
let ws;
let devices = [];
let scenes = [];
let automations = [];

// DOM Elements - Safely get elements
function getElement(id) {
  const element = document.getElementById(id);
  if (!element) {
    console.warn(`Element not found: #${id}`);
  }
  return element;
}

// Initialize WebSocket connection
function initWebSocket() {
  const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
  const wsUrl = `${protocol}//${window.location.host}`;
  
  ws = new WebSocket(wsUrl);
  
  ws.onopen = () => {
    console.log('Connected to server');
    showResponse('Connected to JASON server');
  };
  
  ws.onmessage = (event) => {
    console.log('Received:', event.data);
    
    try {
      const data = JSON.parse(event.data);
      
      if (data.type === 'init') {
        // Initial data
        devices = data.devices || [];
        scenes = data.scenes || [];
        renderDevices();
        renderScenes();
      } else if (data.type === 'command_response') {
        // Command response
        handleCommandResponse(data.result);
      } else if (data.type === 'device_update') {
        // Device update
        updateDevice(data.device);
      }
    } catch (error) {
      // Handle plain text responses
      showResponse(event.data);
    }
  };
  
  ws.onclose = () => {
    console.log('Disconnected from server');
    // Try to reconnect after 2 seconds
    setTimeout(initWebSocket, 2000);
  };
  
  ws.onerror = (error) => {
    console.error('WebSocket error:', error);
  };
}

// Send command to server
function sendCommandToServer(command) {
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({
      type: 'command',
      command: command
    }));
  } else {
    showResponse('Not connected to server. Trying to reconnect...');
    initWebSocket();
  }
}

// Handle command response
function handleCommandResponse(result) {
  if (!result) return;
  
  showResponse(result.content);
  
  if (result.type === 'device_control' || result.type === 'scene_activation') {
    // Refresh UI after device control or scene activation
    setTimeout(() => {
      renderDevices();
      renderScenes();
    }, 500);
  }
}

// Update a single device
function updateDevice(updatedDevice) {
  if (!updatedDevice || !updatedDevice.id) return;
  
  // Find and update the device in our array
  const index = devices.findIndex(d => d.id === updatedDevice.id);
  if (index !== -1) {
    devices[index] = updatedDevice;
    
    // Update UI for this device
    const deviceElements = document.querySelectorAll(`[data-device-id="${updatedDevice.id}"]`);
    deviceElements.forEach(element => {
      updateDeviceElement(element, updatedDevice);
    });
  }
}

// Update a device element in the UI
function updateDeviceElement(element, device) {
  if (!element || !device) return;
  
  // Update status class
  element.className = device.state.power ? 'device-card active' : 'device-card inactive';
  
  // Update status text
  const statusElement = element.querySelector('.device-status');
  if (statusElement) {
    statusElement.textContent = device.state.power ? 'On' : 'Off';
  }
  
  // Update toggle button
  const toggleButton = element.querySelector('.device-toggle');
  if (toggleButton) {
    toggleButton.textContent = device.state.power ? 'Turn Off' : 'Turn On';
  }
  
  // Update specific device type controls
  if (device.type === 'light' && device.state.brightness !== undefined) {
    const brightnessSlider = element.querySelector('.brightness-slider');
    if (brightnessSlider) {
      brightnessSlider.value = device.state.brightness;
    }
  } else if (device.type === 'thermostat' && device.state.temperature !== undefined) {
    const temperatureDisplay = element.querySelector('.temperature-display');
    if (temperatureDisplay) {
      temperatureDisplay.textContent = `${device.state.temperature}°F`;
    }
  }
}

// Render devices
function renderDevices() {
  // Render favorite devices
  const favorites = ['light-1', 'thermostat-1', 'camera-1']; // Mock favorites
  const favoriteDevicesEl = getElement('favorite-devices');
  if (favoriteDevicesEl) {
    renderDeviceGrid(favoriteDevicesEl, devices.filter(d => favorites.includes(d.id)));
  }
  
  // Render all devices
  const allDevicesEl = getElement('all-devices');
  if (allDevicesEl) {
    renderDeviceGrid(allDevicesEl, devices);
  }
}

// Render device grid
function renderDeviceGrid(container, deviceList) {
  if (!container) return;
  
  container.innerHTML = '';
  
  if (!deviceList || deviceList.length === 0) {
    container.innerHTML = '<p>No devices found</p>';
    return;
  }
  
  deviceList.forEach(device => {
    const deviceCard = document.createElement('div');
    deviceCard.className = device.state && device.state.power ? 'device-card active' : 'device-card inactive';
    deviceCard.dataset.deviceId = device.id;
    deviceCard.dataset.deviceType = device.type;
    
    let deviceIcon = 'bi-question-circle';
    switch (device.type) {
      case 'light': deviceIcon = 'bi-lightbulb'; break;
      case 'thermostat': deviceIcon = 'bi-thermometer-half'; break;
      case 'camera': deviceIcon = 'bi-camera-video'; break;
      case 'lock': deviceIcon = 'bi-lock'; break;
      case 'speaker': deviceIcon = 'bi-speaker'; break;
    }
    
    deviceCard.innerHTML = `
      <div class="device-header">
        <span class="device-name">${device.name}</span>
        <i class="bi ${deviceIcon} device-icon"></i>
      </div>
      <div class="device-status">${device.state && device.state.power ? 'On' : 'Off'}</div>
      <div class="device-controls">
        <button class="device-toggle">${device.state && device.state.power ? 'Turn Off' : 'Turn On'}</button>
      </div>
    `;
    
    // Add device-specific controls
    if (device.type === 'light' && device.state && device.state.brightness !== undefined) {
      const brightnessControl = document.createElement('div');
      brightnessControl.className = 'brightness-control';
      brightnessControl.innerHTML = `
        <label>Brightness</label>
        <input type="range" min="1" max="100" value="${device.state.brightness}" class="brightness-slider">
      `;
      deviceCard.querySelector('.device-controls').appendChild(brightnessControl);
      
      // Add event listener for brightness slider
      setTimeout(() => {
        const slider = deviceCard.querySelector('.brightness-slider');
        if (slider) {
          slider.addEventListener('change', (e) => {
            sendCommandToServer(`set ${device.name} brightness to ${e.target.value}`);
          });
        }
      }, 0);
    } else if (device.type === 'thermostat' && device.state && device.state.temperature !== undefined) {
      const tempControl = document.createElement('div');
      tempControl.className = 'temperature-control';
      tempControl.innerHTML = `
        <div class="temperature-display">${device.state.temperature}°F</div>
        <div class="temp-buttons">
          <button class="temp-up">+</button>
          <button class="temp-down">-</button>
        </div>
      `;
      deviceCard.querySelector('.device-controls').appendChild(tempControl);
      
      // Add event listeners for temperature buttons
      setTimeout(() => {
        const upBtn = deviceCard.querySelector('.temp-up');
        const downBtn = deviceCard.querySelector('.temp-down');
        
        if (upBtn) {
          upBtn.addEventListener('click', () => {
            sendCommandToServer(`increase ${device.name} temperature`);
          });
        }
        
        if (downBtn) {
          downBtn.addEventListener('click', () => {
            sendCommandToServer(`decrease ${device.name} temperature`);
          });
        }
      }, 0);
    }
    
    // Add toggle button event listener
    setTimeout(() => {
      const toggleBtn = deviceCard.querySelector('.device-toggle');
      if (toggleBtn) {
        toggleBtn.addEventListener('click', () => {
          const action = device.state && device.state.power ? 'turn off' : 'turn on';
          sendCommandToServer(`${action} ${device.name}`);
        });
      }
    }, 0);
    
    container.appendChild(deviceCard);
  });
}

// Render scenes
function renderScenes() {
  // Render quick scenes
  const quickScenesEl = getElement('quick-scenes');
  if (quickScenesEl) {
    renderSceneGrid(quickScenesEl, scenes.slice(0, 3)); // Just show first 3 scenes
  }
  
  // Render all scenes
  const allScenesEl = getElement('all-scenes');
  if (allScenesEl) {
    renderSceneGrid(allScenesEl, scenes);
  }
}

// Render scene grid
function renderSceneGrid(container, sceneList) {
  if (!container) return;
  
  container.innerHTML = '';
  
  if (!sceneList || sceneList.length === 0) {
    container.innerHTML = '<p>No scenes found</p>';
    return;
  }
  
  sceneList.forEach(scene => {
    const sceneCard = document.createElement('div');
    sceneCard.className = 'scene-card';
    sceneCard.dataset.sceneId = scene.id;
    
    sceneCard.innerHTML = `
      <div class="scene-name">${scene.name}</div>
      <div class="scene-description">${scene.description || ''}</div>
    `;
    
    // Add click event to activate scene
    sceneCard.addEventListener('click', () => {
      sendCommandToServer(`activate scene ${scene.name}`);
    });
    
    container.appendChild(sceneCard);
  });
}

// Render automations
function renderAutomations() {
  const allAutomationsEl = getElement('all-automations');
  if (!allAutomationsEl) return;
  
  allAutomationsEl.innerHTML = '';
  
  if (!automations || automations.length === 0) {
    allAutomationsEl.innerHTML = '<p>No automations found</p>';
    return;
  }
  
  automations.forEach(automation => {
    const automationItem = document.createElement('div');
    automationItem.className = 'automation-item';
    
    automationItem.innerHTML = `
      <div class="automation-header">
        <span class="automation-name">${automation.name}</span>
        <label class="automation-toggle">
          <input type="checkbox" ${automation.isActive ? 'checked' : ''}>
          <span class="automation-slider"></span>
        </label>
      </div>
      <div class="automation-description">${automation.description || ''}</div>
    `;
    
    // Add toggle event listener
    setTimeout(() => {
      const toggle = automationItem.querySelector('input[type="checkbox"]');
      if (toggle) {
        toggle.addEventListener('change', () => {
          const action = toggle.checked ? 'enable' : 'disable';
          sendCommandToServer(`${action} automation ${automation.name}`);
        });
      }
    }, 0);
    
    allAutomationsEl.appendChild(automationItem);
  });
}

// Show response modal
function showResponse(text) {
  const responseText = getElement('responseText');
  const responseModal = getElement('responseModal');
  
  if (!responseText || !responseModal) {
    console.warn('Response elements not found');
    return;
  }
  
  responseText.textContent = text;
  responseModal.classList.add('show');
  
  // Auto-hide after 5 seconds
  setTimeout(() => {
    responseModal.classList.remove('show');
  }, 5000);
}

// Safely add event listener
function safeAddEventListener(element, event, handler) {
  if (element) {
    element.addEventListener(event, handler);
  }
}

// Initialize the application when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
  // Get DOM elements
  const commandInput = getElement('commandInput');
  const sendCommand = getElement('sendCommand');
  const closeBtn = document.querySelector('.close-btn');
  const alexaButton = getElement('alexaButton');
  const googleButton = getElement('googleButton');
  const menuLinks = document.querySelectorAll('.sidebar-menu a');
  const contentAreas = document.querySelectorAll('.content-area');
  const filterButtons = document.querySelectorAll('.filter-btn');
  
  // Initialize WebSocket
  initWebSocket();
  
  // Send command button
  safeAddEventListener(sendCommand, 'click', () => {
    if (!commandInput) return;
    
    const command = commandInput.value.trim();
    if (command) {
      sendCommandToServer(command);
      commandInput.value = '';
    }
  });
  
  // Command input enter key
  safeAddEventListener(commandInput, 'keypress', (e) => {
    if (e.key === 'Enter') {
      const command = commandInput.value.trim();
      if (command) {
        sendCommandToServer(command);
        commandInput.value = '';
      }
    }
  });
  
  // Close response modal
  safeAddEventListener(closeBtn, 'click', () => {
    const responseModal = getElement('responseModal');
    if (responseModal) {
      responseModal.classList.remove('show');
    }
  });
  
  // Voice assistant buttons
  safeAddEventListener(alexaButton, 'click', () => {
    const command = prompt('What would you like to ask Alexa?');
    if (command) {
      sendCommandToServer(`alexa ${command}`);
    }
  });
  
  safeAddEventListener(googleButton, 'click', () => {
    const command = prompt('What would you like to ask Google Assistant?');
    if (command) {
      sendCommandToServer(`google ${command}`);
    }
  });
  
  // Navigation menu
  menuLinks.forEach(link => {
    safeAddEventListener(link, 'click', (e) => {
      e.preventDefault();
      
      // Remove active class from all links
      menuLinks.forEach(l => l.classList.remove('active'));
      
      // Add active class to clicked link
      link.classList.add('active');
      
      // Hide all content areas
      contentAreas.forEach(area => area.classList.add('hidden'));
      
      // Show selected content area
      const targetId = link.getAttribute('href').substring(1) + '-content';
      const targetArea = document.getElementById(targetId);
      if (targetArea) {
        targetArea.classList.remove('hidden');
      }
    });
  });
  
  // Device filters
  filterButtons.forEach(button => {
    safeAddEventListener(button, 'click', () => {
      // Remove active class from all filter buttons
      filterButtons.forEach(btn => btn.classList.remove('active'));
      
      // Add active class to clicked button
      button.classList.add('active');
      
      // Filter devices
      const filter = button.dataset.filter;
      const deviceCards = document.querySelectorAll('#all-devices .device-card');
      
      deviceCards.forEach(card => {
        if (filter === 'all' || card.dataset.deviceType === filter) {
          card.style.display = 'block';
        } else {
          card.style.display = 'none';
        }
      });
    });
  });
});