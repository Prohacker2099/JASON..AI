<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JASON - REAL Sovereign AI OS</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/body-pix@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4"></script>
    <script>
        tailwind.config = {
            theme: { extend: { fontFamily: { 'sans': ['Space Grotesk', 'system-ui', 'sans-serif'], 'mono': ['JetBrains Mono', 'monospace'] } } }
        }
    </script>
    <style>
        .glass-morphism { background: linear-gradient(145deg, rgba(15,23,42,0.95) 0%, rgba(30,41,59,0.9) 50%, rgba(15,23,42,0.95) 100%); backdrop-filter: blur(12px); border: 1px solid rgba(71,85,105,0.4); }
        .gradient-text { background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 50%, #6366f1 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .neural-bg { background: radial-gradient(circle at 20% 20%, rgba(59, 130, 246, 0.1) 0%, transparent 50%), radial-gradient(circle at 80% 80%, rgba(139, 92, 246, 0.1) 0%, transparent 50%), linear-gradient(160deg, #050816 0%, #020617 45%, #000 100%); }
        @keyframes pulse-glow { 0%, 100% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.5); } 50% { box-shadow: 0 0 40px rgba(59, 130, 246, 0.8); } }
        .animate-pulse-glow { animation: pulse-glow 2s ease-in-out infinite; }
        .detection-box { position: absolute; border: 2px solid #00ff00; background: rgba(0, 255, 0, 0.1); pointer-events: none; }
        .ui-element { position: absolute; border: 2px solid #ff6b6b; background: rgba(255, 107, 107, 0.1); }
    </style>
</head>
<body class="neural-bg text-white min-h-screen">
    <nav class="relative z-10 border-b border-slate-800/50 glass-morphism">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <div class="text-2xl font-bold gradient-text">JASON</div>
                    <div class="text-sm text-slate-300">Sovereign Personal OS</div>
                </div>
                <div class="flex space-x-6">
                    <a href="#uam" class="text-slate-300 hover:text-white">UAM</a>
                    <a href="#vlm" class="text-slate-300 hover:text-white">VLM</a>
                    <a href="#commerce" class="text-slate-300 hover:text-white">Commerce</a>
                    <a href="#education" class="text-slate-300 hover:text-white">Education</a>
                    <a href="#trust" class="text-slate-300 hover:text-white">Trust</a>
                    <a href="#web" class="text-slate-300 hover:text-white">Web</a>
                    <a href="#desktop" class="text-slate-300 hover:text-white">Desktop</a>
                </div>
            </div>
        </div>
    </nav>

    <section class="relative z-10 max-w-7xl mx-auto px-4 pt-20 pb-16">
        <div class="text-center">
            <div class="inline-flex items-center px-4 py-2 rounded-full glass-morphism text-sm font-medium mb-8">
                <span class="w-2 h-2 bg-green-400 rounded-full mr-2 animate-pulse"></span>
                <span id="ai-status">INITIALIZING SOVEREIGN OS...</span>
            </div>
            <h1 class="text-5xl md:text-7xl font-bold mb-6">
                <span class="gradient-text">JASON</span><br>
                <span class="text-white">Just Always Synchronized Operational Network</span>
            </h1>
            <p class="text-xl text-slate-300 max-w-4xl mx-auto mb-12">
                <strong>The Universal Action Model (UAM) and the End of the Subscription Economy</strong><br>
                JASON executes tasks at the pixel, packet, and signal level - bypassing paid APIs entirely.
            </p>
            <div class="flex gap-4 justify-center">
                <button onclick="activateJASON()" class="px-8 py-4 bg-gradient-to-r from-red-600 via-orange-600 to-yellow-600 rounded-lg font-semibold animate-pulse-glow">
                    üöÄ ACTIVATE JASON OS
                </button>
                <button onclick="startMarketKiller()" class="px-8 py-4 bg-gradient-to-r from-green-600 to-blue-600 rounded-lg font-semibold">
                    üí• START MARKET KILLER
                </button>
            </div>
        </div>
    </section>

    <section id="trust" class="relative z-10 max-w-7xl mx-auto px-4 py-16">
        <div class="glass-morphism rounded-2xl p-8">
            <h2 class="text-3xl font-bold mb-8">üõ°Ô∏è Trust Gate (Real Approvals)</h2>
            <div class="grid md:grid-cols-2 gap-8">
                <div>
                    <h3 class="text-xl font-semibold mb-4 text-yellow-400">Kill Switch</h3>
                    <div class="glass-morphism rounded-lg p-4">
                        <div class="text-sm text-slate-300 mb-3">When paused, high-impact actions won't run until you unpause.</div>
                        <div class="flex gap-2">
                            <button onclick="setKillSwitch(true)" class="px-4 py-2 bg-red-600 rounded-lg">Pause</button>
                            <button onclick="setKillSwitch(false)" class="px-4 py-2 bg-green-600 rounded-lg">Unpause</button>
                            <button onclick="refreshTrust()" class="px-4 py-2 bg-slate-700 rounded-lg">Refresh</button>
                        </div>
                        <div class="mt-3 text-sm">Status: <span id="trust-status" class="text-slate-300">unknown</span></div>
                    </div>
                </div>
                <div>
                    <h3 class="text-xl font-semibold mb-4 text-orange-400">Pending Prompts</h3>
                    <div id="trust-prompts" class="glass-morphism rounded-lg p-4 h-64 overflow-y-auto">
                        <div class="text-slate-400 text-sm">No prompts yet.</div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="web" class="relative z-10 max-w-7xl mx-auto px-4 py-16">
        <div class="glass-morphism rounded-2xl p-8">
            <h2 class="text-3xl font-bold mb-8">üåê Web Automation (Playwright)</h2>
            <div class="grid md:grid-cols-2 gap-8">
                <div>
                    <h3 class="text-xl font-semibold mb-4 text-blue-400">Sessions</h3>
                    <div class="glass-morphism rounded-lg p-4">
                        <div class="flex gap-2">
                            <button onclick="createWebSessionUI()" class="px-4 py-2 bg-blue-600 rounded-lg">Create Session</button>
                            <button onclick="refreshWebSessions()" class="px-4 py-2 bg-slate-700 rounded-lg">Refresh</button>
                            <button onclick="closeSelectedWebSession()" class="px-4 py-2 bg-red-700 rounded-lg">Close</button>
                        </div>
                        <div class="mt-3">
                            <select id="web-session-select" class="w-full mt-1 px-3 py-2 bg-slate-800 rounded-lg border border-slate-600"></select>
                        </div>
                    </div>

                    <h3 class="text-xl font-semibold mt-8 mb-4 text-green-400">Commands</h3>
                    <div class="glass-morphism rounded-lg p-4">
                        <input type="text" id="web-url" placeholder="https://example.com" class="w-full mt-1 px-3 py-2 bg-slate-800 rounded-lg border border-slate-600">
                        <div class="flex gap-2 mt-3">
                            <button onclick="webNavigate()" class="px-4 py-2 bg-green-600 rounded-lg">Navigate</button>
                            <button onclick="webScreenshot()" class="px-4 py-2 bg-purple-600 rounded-lg">Screenshot</button>
                        </div>
                        <div class="mt-3 text-xs text-slate-400">Navigation is host-allowlisted via `WEB_ALLOWED_HOSTS` on the backend.</div>
                    </div>
                </div>

                <div>
                    <h3 class="text-xl font-semibold mb-4 text-purple-400">Live Screenshot</h3>
                    <div class="glass-morphism rounded-lg p-4">
                        <img id="web-screenshot" class="w-full rounded-lg bg-slate-900" alt="web screenshot" />
                        <div id="web-screenshot-meta" class="text-xs text-slate-400 mt-2"></div>
                    </div>

                    <h3 class="text-xl font-semibold mt-8 mb-4 text-slate-200">Live Logs (SSE)</h3>
                    <div id="live-logs" class="glass-morphism rounded-lg p-4 h-64 overflow-y-auto">
                        <div class="text-slate-400 text-sm">Connecting...</div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="desktop" class="relative z-10 max-w-7xl mx-auto px-4 py-16">
        <div class="glass-morphism rounded-2xl p-8">
            <h2 class="text-3xl font-bold mb-8">üñ•Ô∏è Desktop Control (Local Agent)</h2>
            <div class="grid md:grid-cols-2 gap-8">
                <div>
                    <h3 class="text-xl font-semibold mb-4 text-blue-400">Agent Status</h3>
                    <div class="glass-morphism rounded-lg p-4">
                        <div class="flex gap-2">
                            <button onclick="desktopHealth()" class="px-4 py-2 bg-blue-600 rounded-lg">Agent Health</button>
                            <button onclick="desktopScreenshot()" class="px-4 py-2 bg-purple-600 rounded-lg">Desktop Screenshot</button>
                        </div>
                        <div id="desktop-status" class="text-sm text-slate-300 mt-3">Not checked yet.</div>
                        <div class="text-xs text-slate-400 mt-2">Requires backend env `DESKTOP_AGENT_TOKEN` and agent env `DESKTOP_AGENT_TOKEN` to match.</div>
                    </div>
                </div>
                <div>
                    <h3 class="text-xl font-semibold mb-4 text-purple-400">Desktop Screenshot</h3>
                    <div class="glass-morphism rounded-lg p-4">
                        <img id="desktop-screenshot" class="w-full rounded-lg bg-slate-900" alt="desktop screenshot" />
                        <div id="desktop-screenshot-meta" class="text-xs text-slate-400 mt-2"></div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- UAM Section -->
    <section id="uam" class="relative z-10 max-w-7xl mx-auto px-4 py-16">
        <div class="glass-morphism rounded-2xl p-8">
            <h2 class="text-3xl font-bold mb-8">üéØ Universal Action Model (UAM)</h2>
            <div class="grid md:grid-cols-2 gap-8">
                <div>
                    <h3 class="text-xl font-semibold mb-4 text-blue-400">Pixel-to-Action Mapping</h3>
                    <div class="relative">
                        <video id="uam-camera" class="w-full rounded-lg bg-slate-900" autoplay muted></video>
                        <canvas id="uam-canvas" class="absolute top-0 left-0 w-full h-full rounded-lg"></canvas>
                        <div id="ui-elements" class="absolute top-0 left-0 w-full h-full rounded-lg"></div>
                        <div class="absolute top-4 left-4 glass-morphism px-3 py-1 rounded-full text-sm">
                            <span id="uam-indicator">üî¥ UAM OFF</span>
                        </div>
                    </div>
                    <div class="mt-4 flex gap-2">
                        <button onclick="startUAM()" class="px-4 py-2 bg-blue-600 rounded-lg">üéØ Start UAM</button>
                        <button onclick="analyzeUI()" class="px-4 py-2 bg-green-600 rounded-lg">üîç Analyze UI</button>
                        <button onclick="executeAction()" class="px-4 py-2 bg-red-600 rounded-lg">‚ö° Execute</button>
                    </div>
                </div>
                <div>
                    <h3 class="text-xl font-semibold mb-4 text-green-400">UAM Analysis</h3>
                    <div class="glass-morphism rounded-lg p-4 h-64 overflow-y-auto" id="uam-output">
                        <div class="text-slate-400 text-sm">UAM will analyze UI elements and map them to actions...</div>
                    </div>
                    <div class="mt-4">
                        <h4 class="text-sm font-semibold mb-2 text-yellow-400">Detected UI Elements:</h4>
                        <div id="ui-elements-list" class="flex flex-wrap gap-2"></div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Commerce Engine -->
    <section id="commerce" class="relative z-10 max-w-7xl mx-auto px-4 py-16">
        <div class="glass-morphism rounded-2xl p-8">
            <h2 class="text-3xl font-bold mb-8">üí∞ Commerce Engine - Infinite Scrapes</h2>
            <div class="grid md:grid-cols-2 gap-8">
                <div>
                    <h3 class="text-xl font-semibold mb-4 text-green-400">Hidden Back-End Access</h3>
                    <div class="glass-morphism rounded-lg p-4">
                        <input type="text" id="target-site" placeholder="https://example.com" class="w-full mt-1 px-3 py-2 bg-slate-800 rounded-lg border border-slate-600">
                        <input type="text" id="search-query" placeholder="hotel deals, flight errors..." class="w-full mt-2 px-3 py-2 bg-slate-800 rounded-lg border border-slate-600">
                        <button onclick="startInfiniteScrape()" class="w-full mt-4 px-4 py-3 bg-gradient-to-r from-green-600 to-blue-600 rounded-lg">
                            üöÄ Start Infinite Scrape
                        </button>
                    </div>
                </div>
                <div>
                    <h3 class="text-xl font-semibold mb-4 text-orange-400">Results & Error Fares</h3>
                    <div class="glass-morphism rounded-lg p-4 h-64 overflow-y-auto" id="commerce-output">
                        <div class="text-slate-400 text-sm">Results appear here after a real backend fetch.</div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script>
        let mobileNet, cocoSSD, bodyPix;
        let uamStream = null;
        let isJASONActive = false;
        let ocrWorker = null;
        let uiElements = [];

        async function activateJASON() {
            if (isJASONActive) return;
            
            document.getElementById('ai-status').textContent = 'ACTIVATING JASON OS...';
            
            try {
                await tf.ready();
                await loadAllModels();
                ocrWorker = await Tesseract.createWorker('eng');
                
                isJASONActive = true;
                document.getElementById('ai-status').textContent = 'üöÄ JASON OS ONLINE - SOVEREIGN MODE';
                
            } catch (error) {
                console.error('JASON OS activation failed:', error);
            }
        }

        async function loadAllModels() {
            mobileNet = await mobilenet.load();
            cocoSSD = await cocoSsd.load();
            bodyPix = await bodyPix.load();
        }

        async function startUAM() {
            try {
                const video = document.getElementById('uam-camera');
                uamStream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 } });
                video.srcObject = uamStream;
                document.getElementById('uam-indicator').textContent = 'üü¢ UAM ACTIVE';
            } catch (error) {
                console.error('UAM start failed:', error);
            }
        }

        async function analyzeUI() {
            const video = document.getElementById('uam-camera');
            const canvas = document.getElementById('uam-canvas');
            const ctx = canvas.getContext('2d');
            
            if (!video.srcObject) return;

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);

            document.getElementById('ui-elements').innerHTML = '';
            uiElements = [];

            if (cocoSSD) {
                try {
                    const predictions = await cocoSSD.detect(canvas);
                    predictions.forEach(pred => {
                        if (['laptop', 'cell phone', 'mouse', 'keyboard', 'remote'].includes(pred.class)) {
                            uiElements.push({
                                type: pred.class,
                                bbox: pred.bbox,
                                confidence: pred.score,
                                action: mapToAction(pred.class)
                            });
                            
                            const div = document.createElement('div');
                            div.className = 'ui-element';
                            div.style.left = pred.bbox[0] + 'px';
                            div.style.top = pred.bbox[1] + 'px';
                            div.style.width = pred.bbox[2] + 'px';
                            div.style.height = pred.bbox[3] + 'px';
                            document.getElementById('ui-elements').appendChild(div);
                        }
                    });
                    
                    displayUIElements();
                } catch (error) {
                    console.error('UI analysis failed:', error);
                }
            }
        }

        function mapToAction(objectClass) {
            const actionMap = {
                'laptop': 'click_center',
                'cell phone': 'tap_screen',
                'mouse': 'move_cursor',
                'keyboard': 'type_text',
                'remote': 'press_button'
            };
            return actionMap[objectClass] || 'unknown';
        }

        function displayUIElements() {
            const container = document.getElementById('ui-elements-list');
            container.innerHTML = '';
            
            uiElements.forEach(element => {
                const confidence = (element.confidence * 100).toFixed(1);
                const badge = document.createElement('span');
                badge.className = 'px-2 py-1 bg-red-500/20 rounded text-xs';
                badge.textContent = `${element.type} (${confidence}%) ‚Üí ${element.action}`;
                container.appendChild(badge);
            });
            
            const output = document.getElementById('uam-output');
            const timestamp = new Date().toLocaleTimeString();
            let html = `<div class="mb-4"><strong>UI Analysis [${timestamp}]</strong></div>`;
            
            uiElements.forEach(element => {
                const confidence = (element.confidence * 100).toFixed(1);
                html += `<div class="text-sm mb-1">‚Ä¢ ${element.type} at (${element.bbox[0]}, ${element.bbox[1]}) ‚Üí ${element.action} (${confidence}%)</div>`;
            });
            
            output.innerHTML = html + output.innerHTML;
        }

        async function executeAction() {
            if (uiElements.length === 0) return;
            
            const element = uiElements[0];
            const output = document.getElementById('uam-output');
            const timestamp = new Date().toLocaleTimeString();
            const html = `<div class="mb-4 text-yellow-300"><strong>Action Not Executed [${timestamp}]</strong>: UAM analysis has no real desktop mapping here. Use Desktop Control for real actions.</div>`;
            output.innerHTML = html + output.innerHTML;
        }

        function startMarketKiller() {
            activateJASON();
            alert('Market-killer mode enabled. Run the local backend (npm run dev) for real operations.');
        }

        async function startInfiniteScrape() {
            const site = document.getElementById('target-site').value;
            const query = document.getElementById('search-query').value;
            
            if (!site || !query) {
                alert('Please enter target site and search query');
                return;
            }
            
            const output = document.getElementById('commerce-output');
            const timestamp = new Date().toLocaleTimeString();
            output.innerHTML = `<div class="mb-4"><strong>Fetch started [${timestamp}]</strong></div>
                <div class="text-sm mb-2">URL: ${site}</div>
                <div class="text-sm mb-2">Query: ${query}</div>
                <div class="text-sm text-slate-400">Calling backend /api/commerce/scrape ...</div>` + output.innerHTML;

            try {
                const r = await fetch('/api/commerce/scrape', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: site, query })
                });
                const data = await r.json();

                if (!r.ok || !data || data.ok !== true) {
                    const err = (data && (data.error || data.raw)) ? (data.error || data.raw) : ('HTTP ' + r.status);
                    output.innerHTML = `<div class="mb-4 text-red-400"><strong>Fetch failed</strong>: ${String(err)}</div>` + output.innerHTML;
                    output.innerHTML = `<div class="text-slate-400 text-sm">Tip: backend restricts hosts by default. Set ALLOWED_HOSTS env var to include the domain.</div>` + output.innerHTML;
                    return;
                }

                const title = data.title ? String(data.title) : '(no title)';
                const bytes = typeof data.fetchedBytes === 'number' ? data.fetchedBytes : null;
                const matches = Array.isArray(data.matches) ? data.matches : [];

                let html = `<div class="mb-4 text-green-400"><strong>Fetch OK</strong></div>`;
                html += `<div class="text-sm mb-1">Title: ${title}</div>`;
                html += `<div class="text-sm mb-3">Bytes: ${bytes !== null ? bytes : 'n/a'}</div>`;
                html += `<div class="text-sm mb-2"><strong>Matches (${matches.length}):</strong></div>`;
                html += `<div class="text-sm" style="display:grid;gap:6px;">`;

                for (const m of matches) {
                    const text = m && m.text ? String(m.text) : '';
                    const href = m && m.href ? String(m.href) : '';
                    if (!text) continue;
                    if (href) {
                        html += `<a href="${href}" target="_blank" rel="noreferrer" style="color:#93c5fd;text-decoration:none;font-weight:700;">${text}</a>`;
                    } else {
                        html += `<div>${text}</div>`;
                    }
                }
                html += `</div>`;

                output.innerHTML = html + output.innerHTML;
            } catch (e) {
                output.innerHTML = `<div class="mb-4 text-red-400"><strong>Fetch error</strong>: ${String(e)}</div>` + output.innerHTML;
            }
        }

        function appendLog(type, payload) {
            const el = document.getElementById('live-logs');
            const ts = new Date().toLocaleTimeString();
            const pre = document.createElement('div');
            pre.className = 'text-xs text-slate-300 mb-2';
            const safe = JSON.stringify(payload ?? {}, null, 0);
            pre.textContent = `[${ts}] ${type}: ${safe}`;
            el.prepend(pre);
        }

        async function apiJson(path, opts) {
            const r = await fetch(path, opts);
            const data = await r.json().catch(() => ({}));
            if (!r.ok || (data && data.ok === false)) {
                const msg = (data && data.error) ? data.error : ('HTTP ' + r.status);
                throw new Error(String(msg));
            }
            return data;
        }

        async function waitForJob(jobId, timeoutMs = 30000) {
            const start = Date.now();
            while (Date.now() - start < timeoutMs) {
                const r = await apiJson(`/api/orchestrator/jobs/${encodeURIComponent(jobId)}`);
                const job = r && r.job ? r.job : null;
                if (job && (job.status === 'completed' || job.status === 'failed' || job.status === 'cancelled')) return job;
                await new Promise((resolve) => setTimeout(resolve, 750));
            }
            throw new Error('job_timeout');
        }

        function getSelectedWebSessionId() {
            const sel = document.getElementById('web-session-select');
            return (sel && sel.value) ? String(sel.value) : '';
        }

        async function refreshWebSessions() {
            try {
                const list = await apiJson('/api/web/sessions');
                const sel = document.getElementById('web-session-select');
                sel.innerHTML = '';
                for (const s of list || []) {
                    const opt = document.createElement('option');
                    opt.value = s.id;
                    opt.textContent = `${s.id} (last: ${new Date(s.lastUsedAt).toLocaleTimeString()})`;
                    sel.appendChild(opt);
                }
                if (!sel.value && sel.options.length > 0) sel.value = sel.options[0].value;
            } catch (e) {
                appendLog('ui:error', { where: 'refreshWebSessions', error: String(e) });
            }
        }

        async function createWebSessionUI() {
            try {
                const r = await apiJson('/api/web/session/create', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: '{}' });
                appendLog('web:session_create', r);
                await refreshWebSessions();
                const sel = document.getElementById('web-session-select');
                if (r && r.sessionId) sel.value = r.sessionId;
            } catch (e) {
                appendLog('ui:error', { where: 'createWebSession', error: String(e) });
            }
        }

        async function closeSelectedWebSession() {
            try {
                const id = getSelectedWebSessionId();
                if (!id) return;
                await apiJson('/api/web/session/close', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id }) });
                appendLog('web:session_close', { id });
                await refreshWebSessions();
            } catch (e) {
                appendLog('ui:error', { where: 'closeWebSession', error: String(e) });
            }
        }

        async function webNavigate() {
            const sessionId = getSelectedWebSessionId();
            const url = String(document.getElementById('web-url').value || '').trim();
            if (!sessionId || !url) return;
            try {
                const r = await apiJson('/api/orch/enqueue', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ goal: `web:navigate ${sessionId} ${url}` }) });
                appendLog('orch:enqueue', r);
                const job = await waitForJob(r.jobId);
                appendLog('orch:job_done', job);
            } catch (e) {
                appendLog('ui:error', { where: 'webNavigate', error: String(e) });
            }
        }

        async function webScreenshot() {
            const sessionId = getSelectedWebSessionId();
            if (!sessionId) return;
            try {
                const r = await apiJson('/api/orch/enqueue', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ goal: `web:screenshot ${sessionId}` }) });
                appendLog('orch:enqueue', r);
                const job = await waitForJob(r.jobId);
                appendLog('orch:job_done', job);
                if (job && job.result && job.result.ok && job.result.base64) {
                    const img = document.getElementById('web-screenshot');
                    img.src = `data:${job.result.mime || 'image/jpeg'};base64,${job.result.base64}`;
                    document.getElementById('web-screenshot-meta').textContent = `url=${job.result.url || ''}`;
                }
            } catch (e) {
                appendLog('ui:error', { where: 'webScreenshot', error: String(e) });
            }
        }

        async function refreshTrust() {
            try {
                const r = await apiJson('/api/trust/pending');
                document.getElementById('trust-status').textContent = r.paused ? 'paused' : 'active';
                const wrap = document.getElementById('trust-prompts');
                const prompts = Array.isArray(r.prompts) ? r.prompts : [];
                wrap.innerHTML = '';
                if (prompts.length === 0) {
                    wrap.innerHTML = '<div class="text-slate-400 text-sm">No prompts.</div>';
                    return;
                }
                for (const p of prompts) {
                    const div = document.createElement('div');
                    div.className = 'mb-4 p-3 rounded-lg bg-slate-900/50 border border-slate-700';
                    const title = document.createElement('div');
                    title.className = 'text-sm font-semibold';
                    title.textContent = `${p.title} (L${p.level})`;
                    const rat = document.createElement('div');
                    rat.className = 'text-xs text-slate-300 mt-1';
                    rat.textContent = p.rationale || '';
                    const btns = document.createElement('div');
                    btns.className = 'flex gap-2 mt-3';
                    const approve = document.createElement('button');
                    approve.className = 'px-3 py-1 bg-green-600 rounded';
                    approve.textContent = 'Approve';
                    approve.onclick = () => decidePrompt(p.id, 'approve');
                    const reject = document.createElement('button');
                    reject.className = 'px-3 py-1 bg-red-600 rounded';
                    reject.textContent = 'Reject';
                    reject.onclick = () => decidePrompt(p.id, 'reject');
                    const delay = document.createElement('button');
                    delay.className = 'px-3 py-1 bg-slate-700 rounded';
                    delay.textContent = 'Delay';
                    delay.onclick = () => decidePrompt(p.id, 'delay');
                    btns.appendChild(approve);
                    btns.appendChild(reject);
                    btns.appendChild(delay);
                    div.appendChild(title);
                    div.appendChild(rat);
                    div.appendChild(btns);
                    wrap.appendChild(div);
                }
            } catch (e) {
                appendLog('ui:error', { where: 'refreshTrust', error: String(e) });
            }
        }

        async function setKillSwitch(paused) {
            try {
                await apiJson('/api/trust/kill', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ paused }) });
                await refreshTrust();
            } catch (e) {
                appendLog('ui:error', { where: 'setKillSwitch', error: String(e) });
            }
        }

        async function decidePrompt(id, decision) {
            try {
                await apiJson('/api/trust/decide', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id, decision }) });
                await refreshTrust();
            } catch (e) {
                appendLog('ui:error', { where: 'decidePrompt', error: String(e) });
            }
        }

        async function desktopHealth() {
            try {
                const r = await apiJson('/api/desktop/health');
                document.getElementById('desktop-status').textContent = JSON.stringify(r.agent);
                appendLog('desktop:health', r);
            } catch (e) {
                document.getElementById('desktop-status').textContent = String(e);
                appendLog('ui:error', { where: 'desktopHealth', error: String(e) });
            }
        }

        async function desktopScreenshot() {
            try {
                const r = await apiJson('/api/desktop/execute', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'screenshot', format: 'jpeg', quality: 70 }) });
                appendLog('desktop:screenshot_job', r);
                const job = await waitForJob(r.jobId);
                appendLog('orch:job_done', job);
                const agent = job && job.result && job.result.agent ? job.result.agent : null;
                if (agent && agent.ok && agent.base64) {
                    const img = document.getElementById('desktop-screenshot');
                    img.src = `data:${agent.mime || 'image/jpeg'};base64,${agent.base64}`;
                    document.getElementById('desktop-screenshot-meta').textContent = `${agent.mime || ''}`;
                }
            } catch (e) {
                appendLog('ui:error', { where: 'desktopScreenshot', error: String(e) });
            }
        }

        function connectSSE() {
            try {
                const es = new EventSource('/api/events');
                es.addEventListener('system', (ev) => appendLog('system', JSON.parse(ev.data || '{}')));
                es.addEventListener('ping', (ev) => appendLog('ping', JSON.parse(ev.data || '{}')));
                const types = ['trust:prompt', 'trust:decision', 'orch:job', 'web:session', 'web:session_closed', 'web:browser', 'desktop:command'];
                for (const t of types) {
                    es.addEventListener(t, (ev) => {
                        let payload = {};
                        try { payload = JSON.parse(ev.data || '{}'); } catch { payload = { raw: ev.data }; }
                        appendLog(t, payload);
                        if (t === 'trust:prompt' || t === 'trust:decision') refreshTrust();
                        if (t === 'web:session' || t === 'web:session_closed') refreshWebSessions();
                    });
                }
                es.onerror = () => appendLog('sse:error', { message: 'disconnected' });
            } catch (e) {
                appendLog('sse:error', { error: String(e) });
            }
        }

        window.addEventListener('load', () => {
            connectSSE();
            refreshTrust();
            refreshWebSessions();
        });
    </script>
</body>
</html>
