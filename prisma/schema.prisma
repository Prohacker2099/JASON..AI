// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./jason.db"
}

// Enhanced User Model with Comprehensive Tracking
model User {
  id                   String    @id @default(uuid())
  username             String    @unique
  email                String    @unique
  passwordHash         String
  salt                 String
  // SQLite does not support enum[]; store roles as JSON array of UserRole strings
  roles                Json?
  
  // Authentication and Security
  twoFactorSecret      String?
  twoFactorEnabled     Boolean   @default(false)
  loginAttempts        Int       @default(0)
  lockUntil            DateTime?
  lastLogin            DateTime?
  
  // Profile and Preferences
  profile              UserProfile?
  preferences          UserPreferences?
  
  // Relationships
  devices              Device[]
  communications       Communication[]
  insights             Insight[]
  automations          Automation[]
  scenes               Scene[]
  browserHistory       BrowserHistory[]
  dataMarketplaceTransactions DataMarketplaceTransaction[]
  // Marketplace relations
  developedItems       MarketplaceItem[]      @relation("UserDevelopedItems")
  purchases            MarketplacePurchase[]  @relation("UserPurchases")
  
  // Audit and Tracking
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
}

// Comprehensive Device Model for IoT Integration
model Device {
  id                   String    @id @default(uuid())
  name                 String
  type                 DeviceType
  status               DeviceStatus
  protocol             String
  ipAddress            String?
  
  // Metadata and Configuration
  metadata             Json?
  configuration        Json?
  
  // Energy and Performance Tracking
  energyConsumption    Float?
  performanceMetrics   Json?
  
  // Relationships
  owner                User      @relation(fields: [ownerId], references: [id])
  ownerId              String
  
  // Device History
  history              DeviceHistory[]
  
  // Tracking and Audit
  lastSeen             DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
}

// Detailed Device History for Analytics
model DeviceHistory {
  id                   String    @id @default(uuid())
  device               Device    @relation(fields: [deviceId], references: [id])
  deviceId             String
  status               DeviceStatus
  energyConsumption    Float?
  metadata             Json?
  timestamp            DateTime  @default(now())
}

// Communication Model with Enhanced Tracking
model Communication {
  id                   String    @id @default(uuid())
  type                 CommunicationType
  sender               String
  recipient            String
  content              String
  status               CommunicationStatus
  
  // Relationships
  user                 User      @relation(fields: [userId], references: [id])
  userId               String
  
  // Metadata and Insights
  metadata             Json?
  aiInsights           Json?
  
  // Tracking
  timestamp            DateTime  @default(now())
}

// Learning events captured by the AI engine
model LearningEvent {
  id        String   @id @default(uuid())
  event     String
  data      Json?
  timestamp DateTime @default(now())
}

// AI Insights Model for Knowledge Tracking
model Insight {
  id                   String    @id @default(uuid())
  context              String
  content              String
  type                 InsightType
  
  // Relationships
  user                 User      @relation(fields: [userId], references: [id])
  userId               String
  
  // Metadata
  confidence           Float?
  relevance            Float?
  // SQLite does not support scalar lists; store as JSON array of strings
  sourceUrls           Json?
  
  // Tracking
  generatedAt          DateTime  @default(now())
}

// Lightweight insights specific to the learning engine (no user relation)
model LearningInsight {
  id        String   @id @default(uuid())
  summary   String
  timestamp DateTime @default(now())
}

// Automation Model for Smart Home Scenes
model Automation {
  id                   String    @id @default(uuid())
  name                 String
  description          String?
  
  // Relationships
  user                 User      @relation(fields: [userId], references: [id])
  userId               String
  
  // Automation Configuration
  triggers             Json
  conditions           Json?
  actions              Json
  enabled              Boolean   @default(true)
  
  // Tracking
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
}

// Scene Model for Predefined Environment Configurations
model Scene {
  id                   String    @id @default(uuid())
  name                 String
  description          String?
  
  // Relationships
  user                 User      @relation(fields: [userId], references: [id])
  userId               String
  
  // Scene Configuration
  deviceStates         Json
  mediaSettings        Json?
  
  // Tracking
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
}

// Browser History for Knowledge Mapping
model BrowserHistory {
  id                   String    @id @default(uuid())
  url                  String
  title                String?
  
  // Relationships
  user                 User      @relation(fields: [userId], references: [id])
  userId               String
  
  // Metadata
  duration             Int?
  // SQLite does not support scalar lists; store as JSON array of strings
  tags                 Json?
  aiSummary            Json?
  
  // Tracking
  visitedAt            DateTime  @default(now())
}

// Data Marketplace Transaction Model
model DataMarketplaceTransaction {
  id                   String    @id @default(uuid())
  dataType             String
  description          String?
  anonymizedDataHash   String
  
  // Relationships
  user                 User      @relation(fields: [userId], references: [id])
  userId               String
  
  // Transaction Details
  price                Float
  status               DataMarketplaceTransactionStatus
  
  // Tracking
  createdAt            DateTime  @default(now())
  completedAt          DateTime?
}

// Marketplace models for Plugins/Themes/Integrations
model MarketplaceItem {
  id          String               @id @default(uuid())
  name        String
  type        MarketplaceItemType
  price       Float                @default(0)
  downloads   Int                  @default(0)
  rating      Float                @default(0)

  // Relationships
  developer   User                 @relation("UserDevelopedItems", fields: [developerId], references: [id])
  developerId String
  purchases   MarketplacePurchase[] @relation("ItemPurchases")

  // Tracking
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
}

model MarketplacePurchase {
  id        String          @id @default(uuid())
  user      User            @relation("UserPurchases", fields: [userId], references: [id])
  userId    String
  item      MarketplaceItem @relation("ItemPurchases", fields: [itemId], references: [id])
  itemId    String
  pricePaid Float
  createdAt DateTime        @default(now())
}

// User Profile Model
model UserProfile {
  id                   String    @id @default(uuid())
  user                 User      @relation(fields: [userId], references: [id])
  userId               String    @unique
  
  // Personal Information
  firstName            String?
  lastName             String?
  birthDate            DateTime?
  
  // Wellness Tracking
  sleepScore           Float?
  stressLevel          Float?
  activityLevel        Float?
  
  // Preferences
  timezone             String?
  language             String?
}

// User Preferences Model
model UserPreferences {
  id                   String    @id @default(uuid())
  user                 User      @relation(fields: [userId], references: [id])
  userId               String    @unique
  
  // UI and Interaction Preferences
  theme                String    @default("dark")
  voiceAssistantVoice  String?
  
  // Notification Preferences
  emailNotifications   Boolean   @default(true)
  smsNotifications     Boolean   @default(false)
  
  // Privacy and Data Sharing
  dataMarketplaceConsent Boolean @default(false)
  aiInsightsSharing     Boolean @default(false)
}

// Enums for Type Safety and Clarity
enum UserRole {
  USER
  ADMIN
  DEVELOPER
  ENTERPRISE
}

enum DeviceType {
  LIGHT
  THERMOSTAT
  SECURITY
  MEDIA
  APPLIANCE
  SENSOR
  CUSTOM
}

enum DeviceStatus {
  ON
  OFF
  STANDBY
  ERROR
  CHARGING
}

enum CommunicationType {
  EMAIL
  SMS
  CHAT
  VOICEMAIL
  VIDEO_CALL
}

enum CommunicationStatus {
  SENT
  DELIVERED
  READ
  FAILED
  ARCHIVED
}

enum InsightType {
  DEVICE
  ENERGY
  WELLNESS
  PRODUCTIVITY
  LEARNING
  SOCIAL
}

enum MarketplaceItemType {
  plugin
  theme
  integration
}

enum DataMarketplaceTransactionStatus {
  PENDING
  APPROVED
  COMPLETED
  REJECTED
}

// Enhanced Energy Monitoring Models
model EnergyReading {
  id                   String    @id @default(uuid())
  deviceId             String
  timestamp            DateTime  @default(now())
  
  // Power and Energy Metrics
  powerWatts           Float
  voltageVolts         Float?
  currentAmps          Float?
  powerFactor          Float?
  frequency            Float?
  
  // Cumulative Energy
  energyWh             Float?
  energyKwh            Float?
  
  // Cost and Billing
  costCents            Float?
  tariffRate           Float?
  
  // Quality Metrics
  harmonicDistortion   Float?
  peakDemand           Float?
  
  // Environmental Context
  temperature          Float?
  humidity             Float?
  
  // Metadata
  readingSource        String?   // 'modbus', 'zigbee', 'wifi', etc.
  readingQuality       Float?    // 0-1 confidence score
  anomalyScore         Float?    // AI-detected anomaly score
  
  // Indexes for performance
  @@index([deviceId, timestamp])
  @@index([timestamp])
  @@index([anomalyScore])
}

// Energy Tariff Management
model EnergyTariff {
  id                   String    @id @default(uuid())
  name                 String
  provider             String
  type                 String    // 'fixed', 'time_of_use', 'tiered', 'demand', 'real_time'
  currency             String    @default("USD")
  
  // Rate Structure (stored as JSON for flexibility)
  rates                Json      // Complex rate structures
  timeSchedule         Json?     // Time-based schedules
  seasonalAdjustments  Json?     // Seasonal multipliers
  
  // Validity
  validFrom            DateTime
  validTo              DateTime?
  isActive             Boolean   @default(false)
  
  // Tracking
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  
  // Relations
  costCalculations     EnergyCostCalculation[]
}

// Energy Cost Calculations
model EnergyCostCalculation {
  id                   String    @id @default(uuid())
  deviceId             String
  
  // Period
  periodStart          DateTime
  periodEnd            DateTime
  
  // Usage Breakdown
  energyUsedKwh        Float
  peakUsageKwh         Float     @default(0)
  offPeakUsageKwh      Float     @default(0)
  shoulderUsageKwh     Float     @default(0)
  
  // Cost Breakdown
  energyCost           Float
  demandCost           Float     @default(0)
  connectionCost       Float     @default(0)
  taxesCost            Float     @default(0)
  totalCost            Float
  
  // Tariff Used
  tariff               EnergyTariff @relation(fields: [tariffId], references: [id])
  tariffId             String
  
  // Projections
  projectedMonthlyCost Float?
  
  // Metadata
  calculationMetadata  Json?     // Detailed breakdown, comparisons
  
  // Tracking
  calculatedAt         DateTime  @default(now())
  
  // Indexes
  @@index([deviceId, periodStart, periodEnd])
  @@index([calculatedAt])
}

// Energy Analytics and Insights
model EnergyAnalytics {
  id                   String    @id @default(uuid())
  deviceId             String?
  analysisType         String    // 'pattern', 'anomaly', 'forecast', 'optimization'
  
  // Time Period
  periodStart          DateTime
  periodEnd            DateTime
  
  // Analytics Results
  insights             Json      // AI-generated insights
  patterns             Json?     // Detected patterns
  anomalies            Json?     // Detected anomalies
  predictions          Json?     // Future predictions
  recommendations      Json?     // Optimization recommendations
  
  // Confidence and Quality
  confidenceScore      Float?    // 0-1 confidence in results
  dataQuality          Float?    // 0-1 quality of input data
  
  // Performance Metrics
  energySaved          Float?    // kWh saved from recommendations
  costSaved            Float?    // $ saved from recommendations
  
  // Tracking
  generatedAt          DateTime  @default(now())
  
  // Indexes
  @@index([deviceId, analysisType])
  @@index([generatedAt])
}

// Energy Optimization Rules and Results
model EnergyOptimization {
  id                   String    @id @default(uuid())
  deviceId             String?
  optimizationType     String    // 'load_balancing', 'peak_shaving', 'cost_optimization'
  
  // Rule Configuration
  rules                Json      // Optimization rules
  parameters           Json?     // Algorithm parameters
  
  // Execution Results
  actionsPerformed     Json?     // Actions taken
  energyImpact         Float?    // kWh impact
  costImpact           Float?    // $ impact
  
  // Performance
  executionTime        Float?    // ms
  success              Boolean   @default(true)
  errorMessage         String?
  
  // Tracking
  executedAt           DateTime  @default(now())
  
  // Indexes
  @@index([deviceId, optimizationType])
  @@index([executedAt])
}

// Real-time Energy Pricing
model RealTimeEnergyPrice {
  id                   String    @id @default(uuid())
  timestamp            DateTime  @default(now())
  
  // Pricing Data
  pricePerKwh          Float
  demandCharge         Float?
  
  // Grid Conditions
  gridLoad             Float?    // 0-1 grid utilization
  renewablePercentage  Float?    // 0-1 renewable energy mix
  carbonIntensity      Float?    // g CO2/kWh
  
  // Price Signals
  priceSignal          String?   // 'low', 'medium', 'high', 'critical'
  
  // Forecasting
  forecast24h          Json?     // 24-hour price forecast
  
  // Source
  dataSource           String?   // Grid operator, utility, etc.
  
  // Indexes
  @@index([timestamp])
  @@index([priceSignal])
}

// Energy Device Performance Metrics
model DeviceEnergyMetrics {
  id                   String    @id @default(uuid())
  deviceId             String
  
  // Time Period
  periodStart          DateTime
  periodEnd            DateTime
  
  // Usage Statistics
  totalEnergyKwh       Float
  averagePowerWatts    Float
  peakPowerWatts       Float
  minPowerWatts        Float
  
  // Efficiency Metrics
  efficiencyScore      Float?    // 0-1 efficiency rating
  utilizationRate      Float?    // 0-1 utilization rate
  
  // Cost Metrics
  totalCost            Float?
  costPerKwh           Float?
  
  // Comparison Metrics
  vsLastPeriod         Json?     // Comparison with previous period
  vsSimilarDevices     Json?     // Comparison with similar devices
  
  // Environmental Impact
  carbonFootprintKg    Float?    // kg CO2 equivalent
  
  // Tracking
  calculatedAt         DateTime  @default(now())
  
  // Indexes
  @@index([deviceId, periodStart])
  @@index([calculatedAt])
}

// Energy Anomaly Detection
model EnergyAnomaly {
  id                   String    @id @default(uuid())
  deviceId             String
  
  // Anomaly Details
  anomalyType          String    // 'spike', 'drop', 'pattern_deviation', etc.
  severity             String    // 'low', 'medium', 'high', 'critical'
  
  // Detection Data
  detectedAt           DateTime  @default(now())
  startTime            DateTime
  endTime              DateTime?
  
  // Anomaly Metrics
  expectedValue        Float
  actualValue          Float
  deviationPercent     Float
  anomalyScore         Float     // 0-1 anomaly confidence
  
  // Context
  baselinePattern      Json?     // Normal pattern data
  triggerConditions    Json?     // What triggered the detection
  
  // Resolution
  status               String    @default("active") // 'active', 'investigating', 'resolved', 'false_positive'
  resolvedAt           DateTime?
  resolutionNotes      String?
  
  // Impact Assessment
  energyImpactKwh      Float?
  costImpact           Float?
  
  // Indexes
  @@index([deviceId, detectedAt])
  @@index([severity, status])
  @@index([anomalyType])
}
